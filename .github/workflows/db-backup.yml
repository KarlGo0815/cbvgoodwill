name: ðŸ“¦ PostgreSQL Backup to IONOS (SFTP)

on:
  schedule:
    - cron: '0 2 * * *'  # tÃ¤glich um 2 Uhr nachts
  workflow_dispatch:      # manuell auslÃ¶sbar

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Install PostgreSQL Client
      run: sudo apt-get install -y postgresql-client

    - name: ðŸ“… Generate filename
      run: echo "DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV

    - name: ðŸ§ª Teste Erreichbarkeit von DB-Host
      run: ping -c 3 ${{ secrets.DB_HOST }}

    - name: ðŸ§  Dump PostgreSQL DB
      run: |
        export PGPASSWORD="${{ secrets.DB_PASSWORD }}"
        pg_dump -h ${{ secrets.DB_HOST }} -U ${{ secrets.DB_USER }} -d ${{ secrets.DB_NAME }} > cbvgoodwill-${{ env.DATE }}.sql

    - name: ðŸ“¡ Upload to IONOS SFTP
      uses: wangyucode/sftp-upload-action@v1
      with:
        host: ${{ secrets.IONOS_HOST }}
        username: ${{ secrets.IONOS_USER }}
        password: ${{ secrets.IONOS_PASS }}
        localFile: cbvgoodwill-${{ env.DATE }}.sql
        remotePath: ${{ secrets.IONOS_DIR }}cbvgoodwill-${{ env.DATE }}.sql
